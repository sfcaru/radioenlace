<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Emisor de Audio</title>
</head>
<body>
  <h1>Emisor de Audio</h1>
  <input type="text" id="username" placeholder="Ingresa tu nombre" />
  <button onclick="startTransmission()">Iniciar Transmisión</button>

  <script>
    let localStream;
    let ws;
    let peerConnections = {};

    async function startTransmission() {
      const username = document.getElementById('username').value;
      if (!username) {
        alert('Por favor, ingresa tu nombre.');
        return;
      }

      try {
        // Solicitar acceso al micrófono
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            autoGainControl: false,
            echoCancellation: false,
            googAutoGainControl: false,
            noiseSuppression: false
          },
          video: false, 
        });
        console.log("Micrófono capturado");

        // Conectar al servidor WebSocket
        ws = new WebSocket('wss://radioenlace.onrender.com');

        ws.onopen = () => {
          console.log("Conectado al servidor WebSocket");
          createAndSendOffer(username); // Llama a la función para enviar la oferta inicial
        };

        ws.onclose = () => {
          console.log("Desconectado del servidor WebSocket");
          alert("La conexión con el servidor se ha perdido.");
        };

        ws.onerror = (error) => {
          console.error("Error en la conexión WebSocket:", error);
        };

        // Escuchar mensajes de señalización del servidor
        ws.onmessage = async (message) => {
          const data = JSON.parse(message.data);
          console.log("Mensaje recibido:", data);

          if (data.type === 'answer') {
            await peerConnections[data.id].setRemoteDescription(data.answer);
            console.log("Respuesta (answer) recibida y establecida");
          } else if (data.type === 'candidate' && peerConnections[data.id]) {
            await peerConnections[data.id].addIceCandidate(data.candidate);
            console.log("Candidato ICE añadido:", data.candidate);
          }
        };
      } catch (error) {
        console.error("Error al capturar el micrófono o configurar WebRTC:", error);
      }
    }

    async function createAndSendOffer(username) {
      // Crear una conexión de par para enviar la oferta
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' } // Puedes agregar más servidores STUN si es necesario
        ]
      });
      
      peerConnections[username] = pc; // Usar el nombre de usuario como ID

      // Agregar el micrófono a RTCPeerConnection
      localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));

      // Enviar candidatos ICE al servidor
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: 'candidate',
            id: username, // Enviar el nombre de usuario como ID
            candidate: event.candidate,
          }));
          console.log("Enviando candidato ICE:", event.candidate);
        }
      };

      // Crear una oferta y enviarla al servidor
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      ws.send(JSON.stringify({
        type: 'offer',
        id: username, // Enviar el nombre de usuario como ID
        offer: offer,
      }));
      console.log("Oferta enviada:", offer);
    }
  </script>
</body>
</html>
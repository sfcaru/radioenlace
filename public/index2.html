<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor de Audio Multiusuario</title>
    <style>
        #user-list {
            margin-top: 20px;
            font-weight: bold;
        }
        .user-audio {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h2>Receptor de Audio Multiusuario</h2>
    <div id="user-list">Usuarios conectados:</div>
    <div id="audio-container"></div> <!-- Contenedor para los elementos de audio -->

    <script>
        const socket = new WebSocket('wss://demo.piesocket.com/v3/channel_1');
        const peerConnections = {}; // Guardará las conexiones de cada usuario
        const userList = document.getElementById('user-list'); // Elemento para mostrar los usuarios conectados

        socket.onopen = () => {
            console.log("Conectado al servidor WebSocket");
        };

        socket.onmessage = async (message) => {
            const data = JSON.parse(message.data);

            if (data.type === 'offer') {
                console.log("Mensaje recibido:", data);

                // Mostrar el nombre del usuario que envía la oferta
                const username = data.id; // Asumimos que el ID es el nombre de usuario
                displayUser(username); // Mostrar usuario en la lista

                const peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'wss://radioenlace.onrender.com' }]
                });

                // Manejar la recepción de pistas de audio
                peerConnection.ontrack = (event) => {
                    console.log("Pista de audio recibida");
                    const audioElement = document.createElement('audio');
                    audioElement.srcObject = event.streams[0];
                    audioElement.autoplay = true;
                    audioElement.controls = true;
                    audioElement.style.display = 'block';

                    // Crear un contenedor para el nombre y el audio
                    const userAudioContainer = document.createElement('div');
                    userAudioContainer.className = 'user-audio';
                    userAudioContainer.appendChild(document.createTextNode(username + ': ')); // Mostrar el nombre del usuario
                    userAudioContainer.appendChild(audioElement); // Añadir el audio al contenedor

                    document.getElementById('audio-container').appendChild(userAudioContainer); // Añadir el contenedor al DOM
                    console.log("Elemento de audio añadido al DOM y reproducido");
                };

                // Enviar candidatos ICE al servidor
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({
                            type: 'candidate',
                            id: username,
                            candidate: event.candidate
                        }));
                        console.log("Enviando candidato ICE:", event.candidate);
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Guardar la conexión del usuario actual
                peerConnections[username] = peerConnection;

                // Enviar la respuesta de conexión al usuario
                socket.send(JSON.stringify({
                    type: 'answer',
                    id: username,
                    answer: answer
                }));
                console.log("Respuesta (answer) enviada:", answer);
            } 
            else if (data.type === 'candidate' && peerConnections[data.id]) {
                // Añadir candidatos ICE a la conexión correspondiente
                peerConnections[data.id].addIceCandidate(new RTCIceCandidate(data.candidate));
                console.log("Candidato ICE añadido:", data.candidate);
            }
        };

        socket.onclose = () => {
            console.log("Desconectado del servidor WebSocket");
        };

        function displayUser(username) {
            // Crear un nuevo elemento para mostrar el nombre del usuario
            const userItem = document.createElement('div');
            userItem.textContent = username;
            userList.appendChild(userItem);
        }
    </script>
</body>
</html>
